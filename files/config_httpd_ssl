##############################################################################
# Copyright (c) CERN, 2010.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS
# OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
##############################################################################
#
# NAME :        config_httpd_ssl
#
# DESCRIPTION : This function creates the httpd configuration to enable SSL
#
#
# AUTHORS :     James Casey
#
# YAIM MODULE:  glite-yaim-nagios
#
##############################################################################


config_httpd_ssl_check () {

	requires $1 NAGIOS_ROLE
	
	if [ $NAGIOS_ROLE = "site" ] || [ $NAGIOS_ROLE = "security" ]; then
		return 0
	fi

}

config_httpd_ssl_setenv () {
	
	yaimlog DEBUG "Currently this function doesn't set any environment variables."

}

####@ Creates /etc/httpd/conf.d/ssl.conf
config_httpd_ssl () {
	
	# Skip site/security nagios
	
	if [ $NAGIOS_ROLE = "site" ] || [ $NAGIOS_ROLE = "security" ]  ; then
		yaimlog INFO "Skip poem completely on $NAGIOS_ROLE nagios"
		return 0
	fi
	
	if [ $NAGIOS_ROLE = "vo" ] || [ $NAGIOS_ROLE = "ngi" ] || [ $NAGIOS_ROLE = "opsmonitor" ] ; then
		ssl_path="nagios/"
	elif [ $NAGIOS_ROLE = "central-web" ] ; then
		ssl_path="mywlcg/"
	fi

	NAGIOS_HTTPD_ENABLE_CONFIG=${NAGIOS_HTTPD_ENABLE_CONFIG:-"false"}

	if [ $NAGIOS_HTTPD_ENABLE_CONFIG != "true" ]  ; then
    	yaimlog INFO "/etc/httpd/conf.d/ssl.conf  not being touched"
	else
		yaimlog INFO "Overwriting /etc/httpd/conf.d/ssl.conf"
		if [ ! -f /etc/httpd/conf.d/ssl.conf.PREYAIM ] ; then
			yaimlog INFO "Copying /etc/httpd/conf.d/ssl.conf to ssl.conf.PREYAIM once."
			cp /etc/httpd/conf.d/ssl.conf /etc/httpd/conf.d/ssl.conf.PREYAIM
		fi
		cp /etc/httpd/conf.d/ssl.conf /etc/httpd/conf.d/ssl.conf.old
		cat <<EOF > /etc/httpd/conf.d/ssl.conf

# YAIM generated ssl.conf file.
# Date: `date`

LoadModule ssl_module modules/mod_ssl.so
Listen 443
AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl
SSLPassPhraseDialog  builtin
SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
SSLSessionCacheTimeout  300

SSLMutex default

SSLRandomSeed startup file:/dev/urandom  256
SSLRandomSeed connect builtin

SSLCryptoDevice builtin

<VirtualHost _default_:443>

  ErrorLog logs/ssl_error_log
  CustomLog logs/ssl_access_log combined
  LogLevel warn
  SSLEngine on

  SSLProtocol All -SSLv2 -SSLv3
  SSLCipherSuite ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!MD5:!DSS:!aNULL:!ADH:!eNULL:!EXP:!LOW:!MEDIUM
#  SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP

  SSLCertificateFile /etc/grid-security/hostcert.pem
  SSLCertificateKeyFile /etc/grid-security/hostkey.pem
  SSLCACertificatePath /etc/grid-security/certificates
  SSLCARevocationPath /etc/grid-security/certificates

  SetEnvIf User-Agent ".*MSIE.*" \
         nokeepalive ssl-unclean-shutdown \
         downgrade-1.0 force-response-1.0

  CustomLog logs/ssl_request_log \
          "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"

  SSLVerifyClient      require
  SSLVerifyDepth       5
  
  RewriteEngine On 
  RewriteRule ^/$ https://%{SERVER_NAME}/${ssl_path} [L,R=301]
  
</VirtualHost>

EOF

	fi  # End of NAGIOS_ENABLE_HTTPD_CONFIG
}
